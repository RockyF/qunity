!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n((t=t||self).qunity={})}(this,function(t){"use strict";var n,r,e;(e=r=r||{}).RES="res://",e.ENTITY="entity://";var u=((n={})[r.RES]=function(t,n,e){var o=e.replace(r.RES,"");return t.getRes(o)},n[r.ENTITY]=function(t,n,e,o){var i=function(t,n){return n?n+"_"+t:t}(e.replace(r.ENTITY,""),o);return t.entityMap[i]},n);var i=0;function o(t,n){var e;"prefab"===n.docType&&(e=++i);var o=function t(n,e,o){var i=null;if(e){var r=e.type,p=e.name,s=e.uuid,a=e.children;if(void 0!==o&&void 0!==s&&(s=o+"_"+s),i=n.createEntity(r),p&&(i.name=p),i.uuid=s,l(n,i,e.props),n.entityMap[s]=i,a)for(var c=0,f=a;c<f.length;c++){var u=f[c],y=t(n,u,o);n.addDisplayNode(y,i)}}return i}(t,n,e);return function t(n,e,o,i){for(var r=0,p=o.children.length;r<p;r++){var s=o.children[r],a=e.children[r],c=a.comps;if(c)for(var f=s.entityAdaptor.components,u=0,y=c;u<y.length;u++){var h=y[u],d=f.addComponent(h.id,!1);d.enabled=h.enabled,l(n,d,h.props,i),f.$onAddComponent(d,!0)}t(n,a,s,i)}}(t,n,o,e),function(t,n,e){for(var o=0,i=e.children.length;o<i;o++){var r=e.children[o];if(n.children[o].comps)r.entityAdaptor.components.setActive(!0)}}(0,n,o),o}function l(t,n,e,o){if(e)for(var i in e){var r=e[i];"object"==typeof r?p(t,n,i,r):s(t,n,i,r,o)}}function p(t,n,e,o,i){var r=o,p=!1;switch(o.type){case"raw":p=!0,r=o.data;break;default:Array.isArray(o)&&!n[e]&&(n[e]=[]),l(t,n[e],o,i)}p&&(n[e]=r)}function s(t,n,e,o,i){var r=o;if("string"==typeof o)for(var p=void 0,s=0,a=[u,t.options.protocols];s<a.length;s++){var c=a[s];for(var f in c)if(0===o.indexOf(f)){r=(0,c[f])(t,e,o,i),p=!0;break}if(p)break}n[e]=r}var a=(Object.defineProperty(c.prototype,"options",{get:function(){return this._options},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"stage",{get:function(){return this._options.stage},enumerable:!0,configurable:!0}),c.prototype.setupAdaptor=function(t){return this._options=t,this._mainLoop},c.prototype.instantiate=function(t){return o(this,t)},c.prototype.registerComponentDef=function(t,n){n&&(n.__class__=t,this._componentDefs[t]=n)},c.prototype.registerComponentDefs=function(t){if(t)for(var n in t)this.registerComponentDef(n,t[n])},c.prototype.registerEntityDef=function(t,n){n&&(this._entityDefs[t]=n)},c.prototype.registerEntityDefs=function(t){if(t)for(var n in t)this.registerEntityDef(n,t[n].def)},c.prototype.createEntity=function(t){var n=this._entityDefs[t];if(n){var e=new n;return new this._options.EntityAdaptor(e,this),e}throw new Error("type ["+t+"] not exists.")},c.prototype.addDisplayNode=function(t,n){this._options.addDisplayFunc(t,n)},c.prototype.traverseDisplayNode=function(t,n){this._options.traverseFunc(t,n)},c.prototype.bubblingDisplayNode=function(t,n){this._options.bubblingFunc(t,n)},c.prototype.loadResource=function(t,n,e){this._options.loadResourceFunc(t,n,e)},c.prototype.getRes=function(t){return this._options.getResFunc(t)},c.prototype._onHit=function(t,n){n.entityAdaptor&&n.entityAdaptor.invokeLifecycle("update",t)},c.prototype.$getComponentDef=function(t){var n;switch(typeof t){case"string":n=this._componentDefs[t];break;case"function":n=t}if(n){if(n.__class__)return n;console.warn("component ["+t+"] is not registered.")}else console.warn("component ["+t+"] not exists.")},c);function c(){var n=this;this._componentDefs={},this._entityDefs={},this.entityMap={},this._mainLoop=function(t){n._options.traverseFunc(n._options.stage,n._onHit.bind(n,t))}}var f=0;var y=(Object.defineProperty(h.prototype,"hashCode",{get:function(){return this._hashCode},enumerable:!0,configurable:!0}),h);function h(){this._hashCode=++f}var d=function(t,n){return(d=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var e in n)n.hasOwnProperty(e)&&(t[e]=n[e])})(t,n)};var m,_,v,g=(d(m=C,_=v=y),void(m.prototype=null===_?Object.create(_):(b.prototype=_.prototype,new b)),Object.defineProperty(C.prototype,"entityAdaptor",{get:function(){return this._entityAdaptor},enumerable:!0,configurable:!0}),Object.defineProperty(C.prototype,"entity",{get:function(){return this._entityAdaptor.entity},enumerable:!0,configurable:!0}),Object.defineProperty(C.prototype,"enabled",{get:function(){return this._enabled},set:function(t){this._enabled!=t&&(this._enabled=t,this._entityAdaptor&&this._entityAdaptor.getActive()&&(t?(this._started=!1,this.onEnable()):this.onDisable()))},enumerable:!0,configurable:!0}),C.prototype.$awake=function(t){this._entityAdaptor=t,this.awake()},C.prototype.$destroy=function(){this._entityAdaptor=null,this.onDestroy()},C.prototype.awake=function(){},C.prototype.start=function(){},C.prototype.onEnable=function(){},C.prototype.onDisable=function(){},C.prototype.update=function(t){},C.prototype.onDestroy=function(){},C.prototype.$onUpdate=function(t){this._enabled&&(this._started||(this._started=!0,this.start()),this.update(t))},C.prototype.onClick=function(t){},C.prototype.onMouseDown=function(t){},C.prototype.onMouseMove=function(t){},C.prototype.onMouseUp=function(t){},C.prototype.onMouseUpOutside=function(t){},C.prototype.broadcast=function(n){for(var e=[],t=1;t<arguments.length;t++)e[t-1]=arguments[t];this._entityAdaptor.app.traverseDisplayNode(this.entity,function(t){t.invokeOnComponents&&t.invokeOnComponents(n,e)})},C.prototype.bubbling=function(n){for(var e=[],t=1;t<arguments.length;t++)e[t-1]=arguments[t];this._entityAdaptor.app.bubblingDisplayNode(this.entity,function(t){t.invokeOnComponents&&t.invokeOnComponents(n,e)})},C);function b(){this.constructor=m}function C(){var t=v.call(this)||this;return t._enabled=!1,t._started=!1,t}var A=(D.prototype.applyProxy=function(){var e=this,t=this._entityAdaptor.entity;t.addComponent=function(t){return e.addComponent(t)},t.removeComponent=function(t,n){return e.removeComponent(t,n)},t.removeAllComponents=function(){e.removeAllComponents()},t.getComponent=function(t){return e.getComponent(t)},t.getComponents=function(t){return e.getComponents(t)},t.invokeOnComponents=function(t,n){return e.invokeOnComponents(t,n)}},D.prototype.eachComponent=function(t){this._components.some(t)},D.prototype.setActive=function(n){this.eachComponent(function(t){t.enabled&&(n?t.onEnable():t.onDisable())})},D.prototype.onUpdate=function(n){this.eachComponent(function(t){t.enabled&&t.$onUpdate(n)})},D.prototype.onInteract=function(e,o){this.eachComponent(function(t){if(t.enabled){var n="on"+e[0].toUpperCase()+e.substr(1);t[n]&&t[n](o)}})},D.prototype.addComponent=function(t,n){void 0===n&&(n=!0);var e=this.$instantiateComponent(t);if(e)return this._add(e,void 0,n),e},D.prototype.removeComponent=function(t,n){var e;switch(typeof t){case"string":e=this._findByName(t);break;case"function":e=this._find(t)}return void 0!==n&&(e=[e[n]]),this._remove(e),e},D.prototype.removeAllComponents=function(){this._removeAll()},D.prototype.getComponent=function(t){switch(typeof t){case"string":return this._getByName(t);case"function":return this._getOne(t)}},D.prototype.getComponents=function(t){switch(typeof t){case"string":return this._findByName(t);case"function":return this._find(t)}},D.prototype.getAllComponents=function(){return this.all},D.prototype._add=function(t,n,e){void 0===e&&(e=!0),(null==n||n<0||n>=this._components.length)&&(n=this._components.length),t.entityAdaptor==this._entityAdaptor&&n--;var o=this._components.indexOf(t);o!=n&&(0<=o&&this._components.splice(o,1),this._components.splice(n,0,t),o<0&&this.$onAddComponent(t,e))},D.prototype._remove=function(t){for(var n=0,e=t;n<e.length;n++){var o=e[n];if(o){this.$onRemoveComponent(o);var i=this._components.indexOf(o);this._components.splice(i,1)}}},D.prototype._removeAll=function(){for(;0<this._components.length;){var t=this._components.shift();this.$onRemoveComponent(t)}},D.prototype._findByName=function(n){var t=this._componentsNameMapping[n];return t=t||(this._componentsNameMapping[n]=this._components.filter(function(t){return t.constructor.__class__===n}))},D.prototype._find=function(n){var t=this._componentsDefMapping[n.name];return t=t||(this._componentsDefMapping[n.name]=this._components.filter(function(t){return t instanceof n}))},D.prototype._getByName=function(t){return this._findByName(t)[0]},D.prototype._getOne=function(t){return this._find(t)[0]},Object.defineProperty(D.prototype,"all",{get:function(){return this._components},enumerable:!0,configurable:!0}),D.prototype.invokeOnComponents=function(n,e){this.eachComponent(function(t){t[n]&&t[n].apply(t,e)})},D.prototype.$onAddComponent=function(t,n){void 0===n&&(n=!0),this._componentsNameMapping={},this._componentsDefMapping={},n&&t.$awake(this._entityAdaptor)},D.prototype.$onRemoveComponent=function(t){this._componentsNameMapping={},this._componentsDefMapping={},t.enabled=!1,t.$destroy()},D.prototype.$instantiateComponent=function(t){return new(this._app.$getComponentDef(t))},D);function D(t,n){this._components=[],this._app=n,this._entityAdaptor=t,this.applyProxy()}var O=(Object.defineProperty(w.prototype,"components",{get:function(){return this._components},enumerable:!0,configurable:!0}),Object.defineProperty(w.prototype,"entity",{get:function(){return this._entity},enumerable:!0,configurable:!0}),Object.defineProperty(w.prototype,"app",{get:function(){return this._app},enumerable:!0,configurable:!0}),w.prototype.getActive=function(){return this._entity.$active},w.prototype.setActive=function(t){t!==this.getActive()&&(this._entity.$active=t,this._components.setActive(t))},w.prototype.applyProxy=function(){var t=this._entity;t.$active=!0,Object.defineProperty(t,"active",{get:function(){return this.entityAdaptor.getActive()}}),t.setActive=this.setActive.bind(this)},w.prototype.invokeLifecycle=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];if(this.getActive())switch(t){case"update":var o=n[0];this._components.onUpdate(o)}},w.prototype.invokeInteractionEvent=function(t,n){this.getActive()&&this._components.onInteract(t,n)},w);function w(t,n){this._entity=t,this._app=n,this._components=new A(this,n),(t.entityAdaptor=this).applyProxy()}function M(t,n,e,o){void 0===o&&(o=!1),o||(e=Math.max(0,Math.min(1,e)));var i=n-t;return i=0<i?1:i<0?-1:0,t+Math.abs(n-t)*e*i}t.Application=a,t.Component=g,t.ComponentManager=A,t.EntityAdaptorBase=O,t.HashObject=y,t.lerp=M,t.lerpVector2=function(t,n,e,o){return void 0===o&&(o=!1),{x:M(t.x,n.x,e,o),y:M(t.y,n.y,e,o)}},t.lerpVector3=function(t,n,e,o){return void 0===o&&(o=!1),{x:M(t.x,n.x,e,o),y:M(t.y,n.y,e,o),z:M(t.z,n.z,e,o)}},Object.defineProperty(t,"__esModule",{value:!0})});
